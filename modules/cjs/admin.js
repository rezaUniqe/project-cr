"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var md5=_interopDefault(require("md5")),qs=_interopDefault(require("query-string")),urlJoin=_interopDefault(require("url-join")),__assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function __awaiter(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{u(r.next(e))}catch(e){s(e)}}function i(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}u((r=r.apply(e,t||[])).next())}))}function __generator(e,t){var n,r,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}var clientAuthHash=function(e,t){return void 0===t&&(t=("object"==typeof window?window.CLIENT_AUTH_SECRET:global.CLIENT_AUTH_SECRET)||process.env.REACT_APP_CLIENT_AUTH_SECRET||process.env.WEB_EXT_CLIENT_AUTH_SECRET||process.env.CLIENT_AUTH_SECRET||"952b4412f002315aa50751032fcaab03"),md5(""+t+e)},getMandatoryParams=function(e){var t=Math.round((new Date).getTime()/1e3).toString();return{client_auth_hash:clientAuthHash(t).toString(),session_auth_hash:e,time:t}},prepLoginForm=function(e){var t=e.username,n=e.password,r=e.sessionType,o=e.twoFACode,s=getMandatoryParams(),a={username:t,password:n,time:s.time,client_auth_hash:s.client_auth_hash,session_type_id:r};o&&(a["2fa_code"]=o);var i=function(e){return Object.entries(e).map((function(e){var t=e[0],n=e[1];return encodeURIComponent(t)+"="+encodeURIComponent(n)})).join("&")};return{body:i(a),protectedBody:i(__assign(__assign({},a),{password:n&&n.length>0?"xxxx":"no_set"}))}},globalConfig={apiUrl:process.env.API_URL,assetsUrl:process.env.ASSETS_URL,backupApiUrl:process.env.BACKUP_API_URL,backupAssetsUrl:process.env.BACKUP_ASSETS_URL,sessionAuthHash:null,sessionType:null,dispatch:null,platform:null,apiCallMinInterval:process.env.API_CALL_MIN_INTERVAL||"1000"},setConfig=function(e){globalConfig=__assign(__assign({},globalConfig),e)},getConfig=function(){return globalConfig},prepareValidUrl=function(e){var t,n=e.url,r=e.assets,o=void 0!==r&&r,s=e.useBackup,a=void 0!==s&&s,i=getConfig(),u=i.assetsUrl,d=i.apiUrl,c=i.backupApiUrl,l=i.backupAssetsUrl,p=new RegExp(/^http|ftp|file:\/\//gim);return p.test(n)?n:(t=a?o?l:c:o?u:d,p.test(n)||n.startsWith("/")?!p.test(n)&&n.startsWith("/")?t+n:void 0:t+"/"+n)},_fetch="function"==typeof fetch?fetch:require("node-fetch"),sendRequest=function(e){var t=e.endpoint,n=e.debugOpts,r=void 0===n?{}:n,o=e.opts,s=void 0===o?{}:o,a=e.method,i=void 0===a?"get":a,u=e.assets,d=void 0!==u&&u;return __awaiter(void 0,void 0,Promise,(function(){var e,n,o,a,u,c;return __generator(this,(function(l){switch(l.label){case 0:e=7331,n=__assign(__assign({},s.params),{platform:getConfig().platform}),o=s.method?s:__assign(__assign({},s),{method:i}),a=function(s){return void 0===s&&(s=!1),__awaiter(void 0,void 0,void 0,(function(){var a,i,u,c,l,p,f,g,_,h,v,m,b,C,w;return __generator(this,(function(A){switch(A.label){case 0:if(a=getConfig(),i=a.lastCallTimeStamps,u=void 0===i?{}:i,c=a.apiCallMinInterval,l=s&&t.includes("ExtBlocklists")?__assign(__assign({},n),{domain:"totallyacdn.com"}):n,p=prepareValidUrl({url:t,assets:d,useBackup:s}),f=p+"?"+qs.stringify(l),g=p,global.url=g,(_=Number(c)-(null!==(w=Date.now()-u[t])&&void 0!==w?w:0))>0&&!s)throw{code:e,message:"Last call to "+t+" less than "+c+"ms ago. Call aborted. Retry in "+_+"ms",debug:{debugUrl:g,debugOpts:r,lastCallTimeStamps:u,timeToNextCall:_},data:{debugUrl:g,debugOpts:r,lastCallTimeStamps:u,timeToNextCall:_}};A.label=1;case 1:return A.trys.push([1,3,,4]),setConfig({lastCallTimeStamps:__assign(__assign({},u),(C={},C[t]=Date.now(),C))}),h=new AbortController,setTimeout((function(){return h.abort()}),3e3),v={headers:o.headers,method:o.method,body:o.body,signal:h.signal},[4,fetch(f,v)];case 2:if(404===(m=A.sent()).status)throw{code:m.status,message:m.statusText,debug:{debugUrl:g,debugOpts:r},data:{debugUrl:g,debugOpts:r}};return[2,m];case 3:throw b=A.sent(),console.error(b),{code:0,message:"Error fetching url. "+b.message,debug:{debugUrl:g,debugOpts:r},data:{debugUrl:g,debugOpts:r}};case 4:return[2]}}))}))},l.label=1;case 1:return l.trys.push([1,3,,9]),[4,a()];case 2:return[2,c=l.sent()];case 3:return u=l.sent(),console.error(u.message),c=void 0,u.code!==e?[3,6]:[4,new Promise((function(e){return setTimeout(e,u.data.timeToNextCall)}))];case 4:return l.sent(),[4,a()];case 5:return c=l.sent(),[3,8];case 6:return[4,a(!0)];case 7:c=l.sent(),l.label=8;case 8:return[2,c];case 9:return[2]}}))}))},noop=function(){},dispatcher=function(e){var t=e.getConfig,n=e.dispatch,r=e.actionCreator,o=e.data;return n?n(r(o)):t&&t().dispatch?t().dispatch(r(o)):noop()},createSessionErrorAndDispatchAction=function(e){var t={code:1337,message:"No session auth hash in API"};return e&&dispatcher({actionCreator:e,data:t}),t},parseResponse=function(e){var t=e.response,n=e.debug,r=void 0===n?null:n;return __awaiter(void 0,void 0,void 0,(function(){var e,n,o,s;return __generator(this,(function(a){switch(a.label){case 0:if(!(t.status>=500))return[3,1];throw{code:t.status,message:t.statusText,debug:r,data:r};case 1:return"application/x-ns-proxy-autoconfig"!==t.headers.get("content-type")?[3,3]:[4,t.text()];case 2:if(0===(e=a.sent()).length)throw{code:500,message:"Empty response from API",debug:r,data:r};return[3,5];case 3:return[4,t.json().then((function(e){return e})).catch((function(){return{errorCode:707,errorMessage:"Suspicious activity detected from your network. Please try again soon",errorDescription:"Suspicious activity detected from your network",logStatus:null}}))];case 4:if(e=a.sent(),0===Object.keys(e).length)throw n=0,t.status>0&&(n=t.status),{code:n,message:"Empty response from API",debug:r,data:r};if(e.errorCode||!e.data)throw o=e.errorCode||"No error code present",s=e.errorMessage||"No error message present",{code:o,message:s,debug:r,data:JSON.stringify(e)};a.label=5;case 5:return[2,e]}}))}))},request=function(e){var t=e.method,n=e.endpoint,r=e.opts,o=void 0===r?{}:r,s=e.debugOpts,a=void 0===s?{}:s,i=e.actionCreators,u=i.successfulReduxAction,d=i.failedReduxAction,c=i.loadingReduxAction,l=e.assets,p=void 0!==l&&l;return __awaiter(void 0,void 0,void 0,(function(){var e,r,s;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),c&&dispatcher({getConfig:getConfig,actionCreator:c}),[4,sendRequest({endpoint:n,debugOpts:a,opts:o,method:t,assets:p,actionCreators:{}})];case 1:return e=i.sent(),[4,parseResponse({response:e,debug:{response:e,debugOpts:a,endpoint:n,url:global.url}})];case 2:return r=i.sent(),u&&dispatcher({actionCreator:u,data:r}),[2,r];case 3:if((s=i.sent()).code=s.code||0,!d)throw s;return dispatcher({actionCreator:d,data:s}),[3,4];case 4:return[2]}}))}))},get=function(e){var t=e.endpoint,n=e.params,r=e.actionCreators,o=void 0===r?{}:r;return __awaiter(void 0,void 0,void 0,(function(){var e;return __generator(this,(function(r){switch(r.label){case 0:if(!(e=getConfig().sessionAuthHash))throw createSessionErrorAndDispatchAction(o.failedReduxAction);return[4,request({method:"get",endpoint:t,opts:{params:__assign(__assign({},n),getMandatoryParams(e))},actionCreators:o})];case 1:return[2,r.sent()]}}))}))},post=function(e){var t=e.endpoint,n=e.params,r=e.actionCreators,o=void 0===r?{}:r;return __awaiter(void 0,void 0,void 0,(function(){var e,r,s,a;return __generator(this,(function(i){switch(i.label){case 0:return e=getConfig().sessionAuthHash,r=__assign(__assign({},n),getMandatoryParams(e)),s=qs.stringify(r),[4,request({method:"post",endpoint:t,opts:a={headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s},debugOpts:__assign({},a),actionCreators:o})];case 1:return[2,i.sent()]}}))}))},put=function(e){var t=e.endpoint,n=e.params,r=e.actionCreators,o=void 0===r?{}:r;return __awaiter(void 0,void 0,void 0,(function(){var e,r,s;return __generator(this,(function(a){switch(a.label){case 0:if(!(e=getConfig().sessionAuthHash))throw createSessionErrorAndDispatchAction(o.failedReduxAction);return r=__assign(__assign({},n),getMandatoryParams(e)),s=qs.stringify(r),[4,request({method:"put",endpoint:t,opts:{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s},actionCreators:o})];case 1:return[2,a.sent()]}}))}))},del=function(e){var t=e.endpoint,n=e.params,r=e.actionCreators,o=void 0===r?{}:r;return __awaiter(void 0,void 0,void 0,(function(){var e;return __generator(this,(function(r){switch(r.label){case 0:if(!(e=getConfig().sessionAuthHash))throw createSessionErrorAndDispatchAction(o.failedReduxAction);return[4,request({method:"delete",endpoint:t,opts:{params:__assign(__assign({},n),getMandatoryParams(e))},actionCreators:o})];case 1:return[2,r.sent()]}}))}))},api=Object.freeze({__proto__:null,prepLoginForm:prepLoginForm,request:request,get:get,delete:del,put:put,post:post,dispatcher:dispatcher,sendRequest:sendRequest,setConfig:setConfig,getConfig:getConfig}),sessionTypes={web:1,ext:2,desktop:3,mobile:4},accountStates={active:1,outOfData:2,banned:3},codes=Object.freeze({__proto__:null,sessionTypes:sessionTypes,accountStates:accountStates}),createEndpointMap=function(e){var t=e.api,n=e.endpoints,r=void 0===n?{}:n;return Object.entries(r).reduce((function(e,n){var r=n[0],o=n[1];return"function"==typeof o&&(e[r]=o(t)),e}),{})},_create=function(e){var t=e.conf,n=void 0===t?{}:t,r=e.endpoints,o=void 0===r?{}:r,s=__assign(__assign({},globalConfig),n);return setConfig(s),__assign(__assign(__assign({},api),{codes:codes}),createEndpointMap({api:api,endpoints:o}))},endpoint="/AdminUsers",AdminUsers=function(e){return{get:function(t){var n=void 0===t?{}:t,r=n.userId,o=n.successfulReduxAction,s=void 0===o?null:o,a=n.failedReduxAction,i=void 0===a?null:a,u=n.loadingReduxAction,d=void 0===u?null:u;return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return[4,e.request({method:"post",endpoint:urlJoin(endpoint,r),actionCreators:{failedReduxAction:i,loadingReduxAction:d}})];case 1:return t=n.sent(),s&&e.dispatcher({actionCreator:s,data:t.data}),[2,t.data]}}))}))},getMany:function(t){var n=void 0===t?{}:t,r=n.page,o=void 0===r?null:r,s=n.search,a=void 0===s?null:s,i=n.premium,u=void 0===i?null:i,d=n.affid,c=void 0===d?null:d,l=n.successfulReduxAction,p=void 0===l?null:l,f=n.failedReduxAction,g=void 0===f?null:f,_=n.loadingReduxAction,h=void 0===_?null:_;return __awaiter(this,void 0,void 0,(function(){var t,n;return __generator(this,(function(r){switch(r.label){case 0:return t={page_number:o,identifier:a,premium:u,affid:c},[4,e.get({endpoint:endpoint,params:t,actionCreators:{failedReduxAction:g,loadingReduxAction:h}})];case 1:return n=r.sent(),p&&e.dispatcher({actionCreator:p,data:n.data}),[2,n.data]}}))}))},put:function(t){var n=void 0===t?{}:t,r=n.userId,o=void 0===r?null:r,s=n.billingPlan,a=void 0===s?null:s,i=n.status,u=void 0===i?null:i,d=n.successfulReduxAction,c=void 0===d?null:d,l=n.failedReduxAction,p=void 0===l?null:l,f=n.loadingReduxAction,g=void 0===f?null:f;return __awaiter(this,void 0,void 0,(function(){var t,n;return __generator(this,(function(r){switch(r.label){case 0:if(!o)throw Error("userId is not defined");return t={billing_plan:a,status:u},[4,e.put({params:t,endpoint:endpoint+"/"+o,actionCreators:{failedReduxAction:p,loadingReduxAction:g}})];case 1:return n=r.sent().data,c&&e.dispatcher({actionCreator:c,data:n}),[2,n]}}))}))}}},endpoint$1="/AdminSession",AdminSession=function(e){return{login:function(t){var n=void 0===t?{}:t,r=n.username,o=n.password,s=n.sessionType,a=n.successfulReduxAction,i=void 0===a?null:a,u=n.failedReduxAction,d=void 0===u?null:u,c=n.loadingReduxAction,l=void 0===c?null:c;return __awaiter(this,void 0,void 0,(function(){var t,n,a;return __generator(this,(function(u){switch(u.label){case 0:return[4,e.prepLoginForm({username:r,password:o,sessionType:s})];case 1:return t=u.sent().body,n={headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t},[4,e.request({method:"post",endpoint:endpoint$1,opts:n,actionCreators:{failedReduxAction:d,loadingReduxAction:l}})];case 2:return a=u.sent(),i&&e.dispatcher({actionCreator:i,data:a.data}),[2,a.data]}}))}))}}},endpoints={users:AdminUsers,session:AdminSession};function create(e){return void 0===e&&(e={}),_create({conf:e,endpoints:endpoints})}exports.create=create;
